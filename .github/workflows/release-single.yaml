name: Release single device

on:
  push:
    branches:
      - '*'
    paths:
      - rooted-ota.sh
  pull_request:
    types: [synchronize, opened, reopened]
    paths:
      - rooted-ota.sh
  workflow_call:
    inputs:
      device-id:
        type: string
      magisk-preinit-device:
        type: string
        default: ''
  workflow_dispatch:
    inputs:
      device-id:
        description: Device ID
        required: true
      magisk-preinit-device:
        description: Magisk preinit device
        required: false
      skip-rootless:
        description: skip building rootless OTA
        type: boolean
        required: false
      skip-rooted:
        description: skip building rooted OTA
        type: boolean
        required: false
      upload-test-ota:
        description: Upload OTA to test folder
        required: false
        type: boolean
      force-build:
        description: Force artifacts to be built and uploaded to release if non-existing
        required: false
        type: boolean
      force-ota-server-upload:
        description: Force OTA server upload
        required: false
        type: boolean
      skip-release:
        description: Skip release (build only)
        required: false
        type: boolean
      ota-version:
        description: OTA version
        required: false
      magisk-version:
        description: Magisk version
        required: false

jobs:
  build-device:
    runs-on: ubuntu-latest
    timeout-minutes: 60 # Increased timeout for syncing/uploading
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PUBLIC_REPO_TOKEN }} # Checkout using the powerful token

      - name: Set inputs
        run: |
          # Device Configuration
          echo "DEVICE_ID=$(echo '${{ github.event.inputs.device-id || inputs.device-id || 'mustang' }}' | xargs)" >> $GITHUB_ENV
          
          if [[ "${{ github.event.inputs.skip-rooted }}" != "true" ]]; then
            echo "MAGISK_PREINIT_DEVICE=$(echo '${{ github.event.inputs.magisk-preinit-device || inputs.magisk-preinit-device || 'sda10' }}' | xargs)" >> $GITHUB_ENV
          fi
           
          echo "MAGISK_VERSION=$(echo '${{ github.event.inputs.magisk-version || '' }}' | xargs)" >> $GITHUB_ENV
          echo "OTA_VERSION=$(echo '${{ github.event.inputs.ota-version || '' }}' | xargs)" >> $GITHUB_ENV
          echo "FORCE_OTA_SERVER_UPLOAD=$(echo '${{ github.event.inputs.force-ota-server-upload || '' }}' | xargs)" >> $GITHUB_ENV
          echo "FORCE_BUILD=$(echo '${{ github.event.inputs.force-build || '' }}' | xargs)" >> $GITHUB_ENV
          echo "UPLOAD_TEST_OTA=$(echo '${{ github.event.inputs.upload-test-ota || '' }}' | xargs)" >> $GITHUB_ENV
          echo "SKIP_ROOTLESS=$(echo '${{ github.event.inputs.skip-rootless || '' }}' | xargs)" >> $GITHUB_ENV
          echo "SKIP_RELEASE=$(echo '${{ github.event.inputs.skip-release || '' }}' | xargs)" >> $GITHUB_ENV
           
          if [[ "${{ github.event_name }}" == "push" ]]  || [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "Running on push: Simple build without release for device $DEVICE_ID"
            echo "FORCE_BUILD=true" >> $GITHUB_ENV
            echo "SKIP_RELEASE=true" >> $GITHUB_ENV
            echo "GITHUB_TOKEN=must-be-set-but-is-not-used" >> $GITHUB_ENV
          else
            # Use the PAT for the release step
            echo "GITHUB_TOKEN=${{ secrets.PUBLIC_REPO_TOKEN }}" >> $GITHUB_ENV
          fi

      - run: sudo apt-get install -y jq curl git

      - name: Switch to Public Repo Context
        # This step tricks the script into pushing everything to your PUBLIC repo
        if: env.SKIP_RELEASE != 'true'
        run: |
          # 1. Configure Git with the PAT
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          # 2. Change the 'origin' remote to point to your PUBLIC repo
          # FIXED: Updated URL to use my-graphene-releases
          git remote set-url origin https://slapah:${{ secrets.PUBLIC_REPO_TOKEN }}@github.com/slapah/my-graphene-releases.git
          
          # 3. Fetch the public repo history so we can sync to it
          git fetch origin
          
          # 4. Force sync your current code to the public repo main branch
          # This ensures the tag exists there so the Release can be created
          git push origin HEAD:main --force
          git push origin --tags --force

      - name: release
        env:
          # Point the release script to the PUBLIC repo name
          GITHUB_REPO: slapah/my-graphene-releases
          
          OTA_CHANNEL: "alpha"
          KEY_AVB_BASE64: ${{ secrets.KEY_AVB_BASE64 }}
          CERT_OTA_BASE64: ${{ secrets.CERT_OTA_BASE64 }}
          KEY_OTA_BASE64: ${{ secrets.KEY_OTA_BASE64 }}
          PASSPHRASE_AVB: ${{ secrets.PASSPHRASE_AVB }}
          PASSPHRASE_OTA: ${{ secrets.PASSPHRASE_OTA }}
        run: |
          if [[ $SKIP_RELEASE == 'true' ]]; then
            DEBUG=1 bash -c '. rooted-ota.sh && createRootedOta && createOtaServerData'
          else
            DEBUG=1 bash -c '. rooted-ota.sh && createAndReleaseRootedOta'
          fi
